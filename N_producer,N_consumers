#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>
#include <unistd.h>

#define BUFFER_SIZE 5
#define NUM_ITEMS 10       // items per producer
#define NUM_PRODUCERS 3
#define NUM_CONSUMERS 3

int buffer[BUFFER_SIZE];
int in = 0, out = 0;
int count = 0; // current items in buffer

pthread_mutex_t lock = PTHREAD_MUTEX_INITIALIZER;
pthread_cond_t full = PTHREAD_COND_INITIALIZER;   // buffer full
pthread_cond_t empty = PTHREAD_COND_INITIALIZER;  // buffer empty

void *producer(void *arg) {
    int id = *(int *)arg;

    for (int i = 1; i <= NUM_ITEMS; i++) {
        pthread_mutex_lock(&lock);

        while (count == BUFFER_SIZE) { // buffer full
            pthread_cond_wait(&full, &lock);
        }

        // produce item
        buffer[in] = i;
        printf("Producer %d produced %d at %d\n", id, i, in);
        in = (in + 1) % BUFFER_SIZE;
        count++;

        // signal consumers
        pthread_cond_broadcast(&empty);

        pthread_mutex_unlock(&lock);
        usleep(100000); // simulate work (0.1s)
    }

    pthread_exit(NULL);
}

void *consumer(void *arg) {
    int id = *(int *)arg;

    for (int i = 1; i <= NUM_ITEMS; i++) {
        pthread_mutex_lock(&lock);

        while (count == 0) { // buffer empty
            pthread_cond_wait(&empty, &lock);
        }

        // consume item
        int item = buffer[out];
        printf("\tConsumer %d consumed %d at %d\n", id, item, out);
        out = (out + 1) % BUFFER_SIZE;
        count--;

        // signal producers
        pthread_cond_broadcast(&full);

        pthread_mutex_unlock(&lock);
        usleep(150000); // simulate work (0.15s)
    }

    pthread_exit(NULL);
}

int main() {
    pthread_t producers[NUM_PRODUCERS], consumers[NUM_CONSUMERS];
    int prod_id[NUM_PRODUCERS], cons_id[NUM_CONSUMERS];

    // Create producers
    for (int i = 0; i < NUM_PRODUCERS; i++) {
        prod_id[i] = i + 1;
        pthread_create(&producers[i], NULL, producer, &prod_id[i]);
    }

    // Create consumers
    for (int i = 0; i < NUM_CONSUMERS; i++) {
        cons_id[i] = i + 1;
        pthread_create(&consumers[i], NULL, consumer, &cons_id[i]);
    }

    // Join all threads
    for (int i = 0; i < NUM_PRODUCERS; i++)
        pthread_join(producers[i], NULL);

    for (int i = 0; i < NUM_CONSUMERS; i++)
        pthread_join(consumers[i], NULL);

    printf("All items produced and consumed.\n");

    return 0;
}
